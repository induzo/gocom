<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# idempotency

```go
import "github.com/induzo/gocom/http/middleware/idempotency"
```

This package is an http middleware that does manage idempotency.

## Index

- [Constants](<#constants>)
- [func ErrorToHTTPJSONProblemDetail\(logger \*slog.Logger, writer http.ResponseWriter, req \*http.Request, key string, err error\)](<#ErrorToHTTPJSONProblemDetail>)
- [func NewMiddleware\(store Store, options ...func\(\*config\)\) func\(http.Handler\) http.Handler](<#NewMiddleware>)
- [func WithErrorToHTTPFn\(fn func\(\*slog.Logger, http.ResponseWriter, \*http.Request, string, error\)\) func\(\*config\)](<#WithErrorToHTTPFn>)
- [func WithFingerprinter\(fn func\(\*http.Request\) \(\[\]byte, error\)\) func\(\*config\)](<#WithFingerprinter>)
- [func WithIdempotencyKeyHeader\(header string\) func\(\*config\)](<#WithIdempotencyKeyHeader>)
- [func WithLogger\(logger \*slog.Logger\) func\(\*config\)](<#WithLogger>)
- [func WithOptionalIdempotencyKey\(\) func\(\*config\)](<#WithOptionalIdempotencyKey>)
- [type InMemStore](<#InMemStore>)
  - [func NewInMemStore\(\) \*InMemStore](<#NewInMemStore>)
  - [func \(s \*InMemStore\) GetStoredResponse\(\_ context.Context, key string\) \(\*StoredResponse, bool, error\)](<#InMemStore.GetStoredResponse>)
  - [func \(s \*InMemStore\) StoreResponse\(\_ context.Context, key string, resp \*StoredResponse\) error](<#InMemStore.StoreResponse>)
  - [func \(s \*InMemStore\) TryLock\(ctx context.Context, key string\) \(context.Context, context.CancelFunc, error\)](<#InMemStore.TryLock>)
- [type MismatchedSignatureError](<#MismatchedSignatureError>)
  - [func \(e MismatchedSignatureError\) Error\(\) string](<#MismatchedSignatureError.Error>)
- [type MissingIdempotencyKeyHeaderError](<#MissingIdempotencyKeyHeaderError>)
  - [func \(e MissingIdempotencyKeyHeaderError\) Error\(\) string](<#MissingIdempotencyKeyHeaderError.Error>)
- [type ProblemDetail](<#ProblemDetail>)
- [type RequestInFlightError](<#RequestInFlightError>)
  - [func \(e RequestInFlightError\) Error\(\) string](<#RequestInFlightError.Error>)
- [type Store](<#Store>)
- [type StoredResponse](<#StoredResponse>)


## Constants

<a name="DefaultIdempotencyKeyHeader"></a>

```go
const DefaultIdempotencyKeyHeader = "X-Idempotency-Key"
```

<a name="ErrorToHTTPJSONProblemDetail"></a>
## func [ErrorToHTTPJSONProblemDetail](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L55-L61>)

```go
func ErrorToHTTPJSONProblemDetail(logger *slog.Logger, writer http.ResponseWriter, req *http.Request, key string, err error)
```

ErrorToHTTPJSONProblemDetail converts an error to a RFC9457 problem detail. This is a sample errorToHTTPFn function that handles the specific errors encountered You can add your own func and set it inside the config

<a name="NewMiddleware"></a>
## func [NewMiddleware](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/middleware.go#L13>)

```go
func NewMiddleware(store Store, options ...func(*config)) func(http.Handler) http.Handler
```

Middleware enforces idempotency on non\-GET requests.

<details><summary>Example</summary>
<p>

Using NewMiddleware

```go
package main

import (
	"bytes"
	"context"
	"fmt"
	"io"
	"net/http"
	"net/http/httptest"
	"strconv"
	"sync"
	"sync/atomic"
	"time"

	"github.com/induzo/gocom/http/middleware/idempotency"
)

// Using NewMiddleware
func main() {
	ctx := context.Background()
	idempotencyMiddleware := idempotency.NewMiddleware(idempotency.NewInMemStore())
	mux := http.NewServeMux()

	counter := int32(0)

	mux.Handle("/",
		idempotencyMiddleware(
			http.HandlerFunc(func(respW http.ResponseWriter, _ *http.Request) {
				time.Sleep(100 * time.Millisecond)

				atomic.AddInt32(&counter, 1)

				respW.Write([]byte("Hello World! " + strconv.Itoa(int(counter))))
			})),
	)

	// Serve the handler with http test server
	server := httptest.NewServer(mux)
	defer server.Close()

	// send a first req without a key
	sendPOSTReq(ctx, server, "", "")

	var wg sync.WaitGroup

	for range 3 {
		wg.Add(1)

		go func() {
			defer wg.Done()

			sendPOSTReq(ctx, server, "same-key", "")
		}()

		time.Sleep(80 * time.Millisecond)
	}

}

func sendPOSTReq(ctx context.Context, server *httptest.Server, key, reqBody string) {
	req, _ := http.NewRequestWithContext(ctx, http.MethodPost, server.URL, bytes.NewBufferString(reqBody))
	req.Header.Set(idempotency.DefaultIdempotencyKeyHeader, key)

	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		fmt.Println(err)

		return
	}
	defer resp.Body.Close()

	fmt.Println(resp.StatusCode)

	body, errB := io.ReadAll(resp.Body)
	if errB != nil {
		fmt.Println(errB)

		return
	}

	fmt.Println(string(body))
}
```

#### Output

```
400
{
  "type": "https://example.com/errors/missing-idempotency-key-header",
  "title": "missing idempotency key header",
  "detail": "missing idempotency key header `X-Idempotency-Key` for request to POST /",
  "instance": "/"
}
409
{
  "type": "https://example.com/errors/request-already-in-flight",
  "title": "request already in flight",
  "detail": "request to `POST /` `same-key` still in flight",
  "instance": "/"
}
200
Hello World! 1
200
Hello World! 1
```

</p>
</details>

<a name="WithErrorToHTTPFn"></a>
## func [WithErrorToHTTPFn](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L23>)

```go
func WithErrorToHTTPFn(fn func(*slog.Logger, http.ResponseWriter, *http.Request, string, error)) func(*config)
```

WithErrorToHTTP sets a function to convert errors to HTTP status codes and content.

<a name="WithFingerprinter"></a>
## func [WithFingerprinter](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L37>)

```go
func WithFingerprinter(fn func(*http.Request) ([]byte, error)) func(*config)
```

WithFingerprinter sets a function to build a request fingerprint.

<a name="WithIdempotencyKeyHeader"></a>
## func [WithIdempotencyKeyHeader](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L9>)

```go
func WithIdempotencyKeyHeader(header string) func(*config)
```

WithIdempotencyKeyHeader sets the header to use for idempotency keys.

<a name="WithLogger"></a>
## func [WithLogger](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L30>)

```go
func WithLogger(logger *slog.Logger) func(*config)
```

WithLogger sets the logger to use for logging.

<a name="WithOptionalIdempotencyKey"></a>
## func [WithOptionalIdempotencyKey](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L16>)

```go
func WithOptionalIdempotencyKey() func(*config)
```

WithOptionalIdempotencyKey sets the idempotency key to optional.

<a name="InMemStore"></a>
## type [InMemStore](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L11-L15>)



```go
type InMemStore struct {
    // contains filtered or unexported fields
}
```

<a name="NewInMemStore"></a>
### func [NewInMemStore](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L18>)

```go
func NewInMemStore() *InMemStore
```

NewInMemStore initializes an in\-memory store.

<a name="InMemStore.GetStoredResponse"></a>
### func \(\*InMemStore\) [GetStoredResponse](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L44>)

```go
func (s *InMemStore) GetStoredResponse(_ context.Context, key string) (*StoredResponse, bool, error)
```



<a name="InMemStore.StoreResponse"></a>
### func \(\*InMemStore\) [StoreResponse](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L36>)

```go
func (s *InMemStore) StoreResponse(_ context.Context, key string, resp *StoredResponse) error
```



<a name="InMemStore.TryLock"></a>
### func \(\*InMemStore\) [TryLock](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L25>)

```go
func (s *InMemStore) TryLock(ctx context.Context, key string) (context.Context, context.CancelFunc, error)
```



<a name="MismatchedSignatureError"></a>
## type [MismatchedSignatureError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L31-L35>)



```go
type MismatchedSignatureError struct {
    Method string
    URL    string
    Key    string
}
```

<a name="MismatchedSignatureError.Error"></a>
### func \(MismatchedSignatureError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L37>)

```go
func (e MismatchedSignatureError) Error() string
```



<a name="MissingIdempotencyKeyHeaderError"></a>
## type [MissingIdempotencyKeyHeaderError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L11-L15>)



```go
type MissingIdempotencyKeyHeaderError struct {
    Method         string
    URL            string
    ExpectedHeader string
}
```

<a name="MissingIdempotencyKeyHeaderError.Error"></a>
### func \(MissingIdempotencyKeyHeaderError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L17>)

```go
func (e MissingIdempotencyKeyHeaderError) Error() string
```



<a name="ProblemDetail"></a>
## type [ProblemDetail](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L42-L50>)

Conforming to RFC9457 \(https://www.rfc-editor.org/rfc/rfc9457.html\)

```go
type ProblemDetail struct {
    HTTPStatusCode int `json:"-"`

    Type             string         `json:"type"`
    Title            string         `json:"title"`
    Detail           string         `json:"detail"`
    Instance         string         `json:"instance"`
    ExtensionMembers map[string]any `json:",omitempty"`
}
```

<a name="RequestInFlightError"></a>
## type [RequestInFlightError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L21-L25>)



```go
type RequestInFlightError struct {
    Method string
    URL    string
    Key    string
}
```

<a name="RequestInFlightError.Error"></a>
### func \(RequestInFlightError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L27>)

```go
func (e RequestInFlightError) Error() string
```



<a name="Store"></a>
## type [Store](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/store.go#L21-L32>)

Store is the interface we need to implement for: Locking an idemkey Storing a response Retrieving a response

```go
type Store interface {
    // Lock inserts a marker that a request with a given key/signature is in-flight.
    TryLock(ctx context.Context, key string) (context.Context, context.CancelFunc, error)

    // MarkComplete records the final response for a request key.
    StoreResponse(ctx context.Context, key string, resp *StoredResponse) error

    // GetStoredResponse returns the final stored response (if any) for this key.
    // The second return value is false if the key is not found.
    // The third return value is an error if the operation failed.
    GetStoredResponse(ctx context.Context, key string) (*StoredResponse, bool, error)
}
```

<a name="StoredResponse"></a>
## type [StoredResponse](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/store.go#L9-L15>)

StoredResponse holds what we need to check and replay a response.

```go
type StoredResponse struct {
    StatusCode       int
    Signature        []byte
    Headers          http.Header
    Body             []byte
    RequestSignature []byte // To verify the same request payload
}
```

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
