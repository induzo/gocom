<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# idempotency

```go
import "github.com/induzo/gocom/http/middleware/idempotency"
```

Package idempotency provides an HTTP middleware for managing idempotency. Idempotency ensures that multiple identical requests have the same effect as making a single request, which is useful for operations like payment processing where duplicate requests could lead to unintended consequences. This package is an http middleware that does manage idempotency.

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func ErrorToHTTPJSONProblemDetail\(respW http.ResponseWriter, req \*http.Request, err error\)](<#ErrorToHTTPJSONProblemDetail>)
- [func NewMiddleware\(store Store, options ...Option\) func\(http.Handler\) http.Handler](<#NewMiddleware>)
- [type ContextKey](<#ContextKey>)
- [type ErrorToHTTPFn](<#ErrorToHTTPFn>)
- [type GetStoredResponseError](<#GetStoredResponseError>)
  - [func \(e GetStoredResponseError\) Error\(\) string](<#GetStoredResponseError.Error>)
  - [func \(e GetStoredResponseError\) Unwrap\(\) error](<#GetStoredResponseError.Unwrap>)
- [type InMemStore](<#InMemStore>)
  - [func NewInMemStore\(\) \*InMemStore](<#NewInMemStore>)
  - [func \(s \*InMemStore\) Close\(\)](<#InMemStore.Close>)
  - [func \(s \*InMemStore\) GetStoredResponse\(\_ context.Context, key string\) \(\*StoredResponse, bool, error\)](<#InMemStore.GetStoredResponse>)
  - [func \(s \*InMemStore\) SetResponseTTL\(ttl time.Duration\)](<#InMemStore.SetResponseTTL>)
  - [func \(s \*InMemStore\) StoreResponse\(\_ context.Context, key string, resp \*StoredResponse\) error](<#InMemStore.StoreResponse>)
  - [func \(s \*InMemStore\) TryLock\(ctx context.Context, key string\) \(context.Context, context.CancelFunc, error\)](<#InMemStore.TryLock>)
- [type InvalidIdempotencyKeyError](<#InvalidIdempotencyKeyError>)
  - [func \(e InvalidIdempotencyKeyError\) Error\(\) string](<#InvalidIdempotencyKeyError.Error>)
  - [func \(e InvalidIdempotencyKeyError\) Unwrap\(\) error](<#InvalidIdempotencyKeyError.Unwrap>)
- [type MismatchedSignatureError](<#MismatchedSignatureError>)
  - [func \(e MismatchedSignatureError\) Error\(\) string](<#MismatchedSignatureError.Error>)
- [type MissingIdempotencyKeyHeaderError](<#MissingIdempotencyKeyHeaderError>)
  - [func \(e MissingIdempotencyKeyHeaderError\) Error\(\) string](<#MissingIdempotencyKeyHeaderError.Error>)
- [type Option](<#Option>)
  - [func WithAffectedMethods\(methods ...string\) Option](<#WithAffectedMethods>)
  - [func WithAllowedReplayHeaders\(headers ...string\) Option](<#WithAllowedReplayHeaders>)
  - [func WithErrorToHTTPFn\(fn func\(http.ResponseWriter, \*http.Request, error\)\) Option](<#WithErrorToHTTPFn>)
  - [func WithFingerprinter\(fn func\(\*http.Request\) \(\[\]byte, error\)\) Option](<#WithFingerprinter>)
  - [func WithIdempotencyKeyHeader\(header string\) Option](<#WithIdempotencyKeyHeader>)
  - [func WithIdempotentReplayedHeader\(header string\) Option](<#WithIdempotentReplayedHeader>)
  - [func WithIgnoredURLPaths\(urlPaths ...string\) Option](<#WithIgnoredURLPaths>)
  - [func WithOptionalIdempotencyKey\(\) Option](<#WithOptionalIdempotencyKey>)
  - [func WithTracer\(tracerFn TracerFn\) Option](<#WithTracer>)
  - [func WithUserIDExtractor\(fn UserIDExtractorFn\) Option](<#WithUserIDExtractor>)
- [type ProblemDetail](<#ProblemDetail>)
- [type RequestContext](<#RequestContext>)
  - [func \(idrc RequestContext\) String\(\) string](<#RequestContext.String>)
- [type RequestInFlightError](<#RequestInFlightError>)
  - [func \(e RequestInFlightError\) Error\(\) string](<#RequestInFlightError.Error>)
- [type Store](<#Store>)
- [type StoreResponseError](<#StoreResponseError>)
  - [func \(e StoreResponseError\) Error\(\) string](<#StoreResponseError.Error>)
  - [func \(e StoreResponseError\) Unwrap\(\) error](<#StoreResponseError.Unwrap>)
- [type StoredResponse](<#StoredResponse>)
- [type TracerFn](<#TracerFn>)
- [type UserIDExtractorFn](<#UserIDExtractorFn>)


## Constants

<a name="DefaultIdempotencyKeyHeader"></a>

```go
const (
    DefaultIdempotencyKeyHeader             = "X-Idempotency-Key"
    DefaultIdempotentReplayedResponseHeader = "X-Idempotent-Replayed"
)
```

## Variables

<a name="ErrEmptyKey"></a>Validation errors.

```go
var (
    ErrEmptyKey        = errors.New("idempotency key cannot be empty")
    ErrKeyTooLong      = errors.New("idempotency key too long")
    ErrInvalidKeyChars = errors.New("idempotency key contains invalid characters")
)
```

<a name="ErrorToHTTPJSONProblemDetail"></a>
## func [ErrorToHTTPJSONProblemDetail](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L132-L136>)

```go
func ErrorToHTTPJSONProblemDetail(respW http.ResponseWriter, req *http.Request, err error)
```

ErrorToHTTPJSONProblemDetail converts an error to a RFC9457 problem detail. This is a sample errorToHTTPFn function that handles the specific errors encountered You can add your own func and set it inside the config

<a name="NewMiddleware"></a>
## func [NewMiddleware](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/middleware.go#L16>)

```go
func NewMiddleware(store Store, options ...Option) func(http.Handler) http.Handler
```

Middleware enforces idempotency on non\-GET requests.

<details><summary>Example</summary>
<p>

Using NewMiddleware

```go
package main

import (
	"bytes"
	"context"
	"fmt"
	"io"
	"net/http"
	"net/http/httptest"
	"strconv"
	"sync"
	"sync/atomic"
	"time"

	"github.com/induzo/gocom/http/middleware/idempotency"
)

// Using NewMiddleware
func main() {
	ctx := context.Background()

	store := idempotency.NewInMemStore()
	defer store.Close()

	idempotencyMiddleware := idempotency.NewMiddleware(store)
	mux := http.NewServeMux()

	counter := int32(0)

	mux.Handle("/",
		idempotencyMiddleware(
			http.HandlerFunc(func(respW http.ResponseWriter, _ *http.Request) {
				time.Sleep(100 * time.Millisecond)

				atomic.AddInt32(&counter, 1)

				respW.Write([]byte("Hello World! " + strconv.Itoa(int(counter))))
			})),
	)

	// Serve the handler with http test server
	server := httptest.NewServer(mux)
	defer server.Close()

	// send a first req without a key
	sendPOSTReq(ctx, server, "", "")

	var wg sync.WaitGroup

	for range 3 {
		wg.Go(func() {
			sendPOSTReq(ctx, server, "same-key", "")
		})

		time.Sleep(80 * time.Millisecond)
	}

}

func sendPOSTReq(ctx context.Context, server *httptest.Server, key, reqBody string) {
	req, _ := http.NewRequestWithContext(
		ctx,
		http.MethodPost,
		server.URL,
		bytes.NewBufferString(reqBody),
	)
	req.Header.Set(idempotency.DefaultIdempotencyKeyHeader, key)

	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		fmt.Println(err)

		return
	}
	defer resp.Body.Close()

	fmt.Println(resp.StatusCode)

	body, errB := io.ReadAll(resp.Body)
	if errB != nil {
		fmt.Println(errB)

		return
	}

	fmt.Println(string(body))
}
```

#### Output

```
400
{
  "type": "errors/missing-idempotency-key-header",
  "title": "missing idempotency key header",
  "detail": "missing idempotency key header `X-Idempotency-Key`",
  "instance": "/"
}
409
{
  "type": "errors/request-already-in-flight",
  "title": "request already in flight",
  "detail": "request with key `X-Idempotency-Key`:`same-key` still in flight",
  "instance": "/"
}
200
Hello World! 1
200
Hello World! 1
```

</p>
</details>

<a name="ContextKey"></a>
## type [ContextKey](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/middleware.go#L233>)



```go
type ContextKey string
```

<a name="IdempotencyKeyCtxKey"></a>

```go
const IdempotencyKeyCtxKey ContextKey = "idempotency_key"
```

<a name="ErrorToHTTPFn"></a>
## type [ErrorToHTTPFn](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/config.go#L12>)



```go
type ErrorToHTTPFn func(http.ResponseWriter, *http.Request, error)
```

<a name="GetStoredResponseError"></a>
## type [GetStoredResponseError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L96-L99>)



```go
type GetStoredResponseError struct {
    RequestContext
    Err error
}
```

<a name="GetStoredResponseError.Error"></a>
### func \(GetStoredResponseError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L102>)

```go
func (e GetStoredResponseError) Error() string
```



<a name="GetStoredResponseError.Unwrap"></a>
### func \(GetStoredResponseError\) [Unwrap](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L112>)

```go
func (e GetStoredResponseError) Unwrap() error
```



<a name="InMemStore"></a>
## type [InMemStore](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L18-L26>)



```go
type InMemStore struct {
    // contains filtered or unexported fields
}
```

<a name="NewInMemStore"></a>
### func [NewInMemStore](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L34>)

```go
func NewInMemStore() *InMemStore
```

NewInMemStore initializes an in\-memory store with automatic cleanup.

<a name="InMemStore.Close"></a>
### func \(\*InMemStore\) [Close](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L52>)

```go
func (s *InMemStore) Close()
```

Close stops the background cleanup goroutine.

<a name="InMemStore.GetStoredResponse"></a>
### func \(\*InMemStore\) [GetStoredResponse](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L153-L156>)

```go
func (s *InMemStore) GetStoredResponse(_ context.Context, key string) (*StoredResponse, bool, error)
```



<a name="InMemStore.SetResponseTTL"></a>
### func \(\*InMemStore\) [SetResponseTTL](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L192>)

```go
func (s *InMemStore) SetResponseTTL(ttl time.Duration)
```

SetResponseTTL configures how long responses should be cached.

<a name="InMemStore.StoreResponse"></a>
### func \(\*InMemStore\) [StoreResponse](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L126-L130>)

```go
func (s *InMemStore) StoreResponse(_ context.Context, key string, resp *StoredResponse) error
```



<a name="InMemStore.TryLock"></a>
### func \(\*InMemStore\) [TryLock](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/inmem.go#L99-L102>)

```go
func (s *InMemStore) TryLock(ctx context.Context, key string) (context.Context, context.CancelFunc, error)
```



<a name="InvalidIdempotencyKeyError"></a>
## type [InvalidIdempotencyKeyError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L40-L43>)



```go
type InvalidIdempotencyKeyError struct {
    RequestContext
    Err error
}
```

<a name="InvalidIdempotencyKeyError.Error"></a>
### func \(InvalidIdempotencyKeyError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L46>)

```go
func (e InvalidIdempotencyKeyError) Error() string
```



<a name="InvalidIdempotencyKeyError.Unwrap"></a>
### func \(InvalidIdempotencyKeyError\) [Unwrap](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L56>)

```go
func (e InvalidIdempotencyKeyError) Unwrap() error
```



<a name="MismatchedSignatureError"></a>
## type [MismatchedSignatureError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L68-L70>)



```go
type MismatchedSignatureError struct {
    RequestContext
}
```

<a name="MismatchedSignatureError.Error"></a>
### func \(MismatchedSignatureError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L72>)

```go
func (e MismatchedSignatureError) Error() string
```



<a name="MissingIdempotencyKeyHeaderError"></a>
## type [MissingIdempotencyKeyHeaderError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L32-L34>)



```go
type MissingIdempotencyKeyHeaderError struct {
    RequestContext
}
```

<a name="MissingIdempotencyKeyHeaderError.Error"></a>
### func \(MissingIdempotencyKeyHeaderError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L36>)

```go
func (e MissingIdempotencyKeyHeaderError) Error() string
```



<a name="Option"></a>
## type [Option](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L7>)



```go
type Option func(*config)
```

<a name="WithAffectedMethods"></a>
### func [WithAffectedMethods](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L46>)

```go
func WithAffectedMethods(methods ...string) Option
```

WithAffectedMethods sets the methods that are affected by idempotency. By default, POST only are affected.

<a name="WithAllowedReplayHeaders"></a>
### func [WithAllowedReplayHeaders](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L87>)

```go
func WithAllowedReplayHeaders(headers ...string) Option
```

WithAllowedReplayHeaders sets the list of headers that are safe to replay. Only these headers will be copied from the stored response.

<a name="WithErrorToHTTPFn"></a>
### func [WithErrorToHTTPFn](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L31>)

```go
func WithErrorToHTTPFn(fn func(http.ResponseWriter, *http.Request, error)) Option
```

WithErrorToHTTPFn sets a function to convert errors to HTTP status codes and content.

<a name="WithFingerprinter"></a>
### func [WithFingerprinter](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L38>)

```go
func WithFingerprinter(fn func(*http.Request) ([]byte, error)) Option
```

WithFingerprinter sets a function to build a request fingerprint.

<a name="WithIdempotencyKeyHeader"></a>
### func [WithIdempotencyKeyHeader](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L17>)

```go
func WithIdempotencyKeyHeader(header string) Option
```

WithIdempotencyKeyHeader sets the header to use for idempotency keys.

<a name="WithIdempotentReplayedHeader"></a>
### func [WithIdempotentReplayedHeader](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L24>)

```go
func WithIdempotentReplayedHeader(header string) Option
```

WithIdempotentReplayedHeader sets the header to use for idempotent replayed responses.

<a name="WithIgnoredURLPaths"></a>
### func [WithIgnoredURLPaths](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L54>)

```go
func WithIgnoredURLPaths(urlPaths ...string) Option
```

WithIgnoredURLPaths sets the URL paths that are ignored by idempotency. By default, no URLs are ignored.

<a name="WithOptionalIdempotencyKey"></a>
### func [WithOptionalIdempotencyKey](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L10>)

```go
func WithOptionalIdempotencyKey() Option
```

WithOptionalIdempotencyKey sets the idempotency key to optional.

<a name="WithTracer"></a>
### func [WithTracer](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L107>)

```go
func WithTracer(tracerFn TracerFn) Option
```

WithTracer sets a tracer function to add observability spans to the middleware. The tracer function receives the request and span name, and should return a function to end the span \(to be called with defer\).

Example with OpenTelemetry:

```
func(req *http.Request, spanName string) func() {
	ctx, span := otel.Tracer("idempotency").Start(req.Context(), spanName)
	newReq := req.WithContext(ctx)

	*req = *newReq

	return func() { span.End() }
}
```

<a name="WithUserIDExtractor"></a>
### func [WithUserIDExtractor](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/options.go#L79>)

```go
func WithUserIDExtractor(fn UserIDExtractorFn) Option
```

WithUserIDExtractor sets a function to extract user/tenant ID from the request. This is used to scope idempotency keys to specific users/tenants.

<a name="ProblemDetail"></a>
## type [ProblemDetail](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L117-L125>)

Conforming to RFC9457 \(https://www.rfc-editor.org/rfc/rfc9457.html\)

```go
type ProblemDetail struct {
    HTTPStatusCode int `json:"-"`

    Type             string         `json:"type"`
    Title            string         `json:"title"`
    Detail           string         `json:"detail"`
    Instance         string         `json:"instance"`
    ExtensionMembers map[string]any `json:",omitempty"`
}
```

<a name="RequestContext"></a>
## type [RequestContext](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L12-L17>)



```go
type RequestContext struct {
    URL       string
    Method    string
    KeyHeader string
    Key       string
}
```

<a name="RequestContext.String"></a>
### func \(RequestContext\) [String](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L19>)

```go
func (idrc RequestContext) String() string
```



<a name="RequestInFlightError"></a>
## type [RequestInFlightError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L60-L62>)



```go
type RequestInFlightError struct {
    RequestContext
}
```

<a name="RequestInFlightError.Error"></a>
### func \(RequestInFlightError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L64>)

```go
func (e RequestInFlightError) Error() string
```



<a name="Store"></a>
## type [Store](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/store.go#L21-L33>)

Store is the interface we need to implement for: Locking an idemkey Storing a response Retrieving a response

```go
type Store interface {
    // Lock inserts a marker that a request with a given key/signature is in-flight.
    // The lock should have a timeout to prevent indefinite holding.
    TryLock(ctx context.Context, key string) (context.Context, context.CancelFunc, error)

    // MarkComplete records the final response for a request key.
    StoreResponse(ctx context.Context, key string, resp *StoredResponse) error

    // GetStoredResponse returns the final stored response (if any) for this key.
    // The second return value is false if the key is not found.
    // The third return value is an error if the operation failed.
    GetStoredResponse(ctx context.Context, key string) (*StoredResponse, bool, error)
}
```

<a name="StoreResponseError"></a>
## type [StoreResponseError](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L76-L79>)



```go
type StoreResponseError struct {
    RequestContext
    Err error
}
```

<a name="StoreResponseError.Error"></a>
### func \(StoreResponseError\) [Error](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L82>)

```go
func (e StoreResponseError) Error() string
```



<a name="StoreResponseError.Unwrap"></a>
### func \(StoreResponseError\) [Unwrap](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/errors.go#L92>)

```go
func (e StoreResponseError) Unwrap() error
```



<a name="StoredResponse"></a>
## type [StoredResponse](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/store.go#L9-L15>)

StoredResponse holds what we need to check and replay a response.

```go
type StoredResponse struct {
    StatusCode  int
    Signature   []byte
    Header      http.Header
    Body        []byte
    RequestHash []byte // To verify the same request payload
}
```

<a name="TracerFn"></a>
## type [TracerFn](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/config.go#L22>)

TracerFn is a function that starts a span with the given name and returns a function to end the span. This allows integration with any tracing library \(OpenTelemetry, DataDog, Jaeger, etc.\). The returned function should be called with defer to ensure the span is ended.

```go
type TracerFn func(req *http.Request, spanName string) func()
```

<a name="UserIDExtractorFn"></a>
## type [UserIDExtractorFn](<https://github.com/induzo/gocom/blob/main/http/middleware/idempotency/config.go#L16>)

UserIDExtractorFn extracts the user/tenant ID from the request context. Return empty string if no user context is available.

```go
type UserIDExtractorFn func(*http.Request) string
```

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
